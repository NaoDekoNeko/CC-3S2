<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Ademar\OneDrive\Desktop\Practica1-C3S2\Sprint5\ReSOSgame\ReSOSgame\Form1.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ReSOSgame
{
    public partial class Form1 : Form
    {
        //private bool actualizarGrid = false;

        // Inicializa las componente e instancia el objeto controller
        private readonly Controller controller;

        public Form1()
        {
            InitializeComponent();
            controller = new Controller();
        }

        //Este m&#233;todo convierte un array 2D de cualquier tipo a un DataTable;        
        private DataTable ConvertToDataTable&lt;T&gt;(T[,] array)
        {
            var table = new DataTable();
            for (var i = 0; i &lt; array.GetLength(1); i++) table.Columns.Add($&quot;Column{i + 1}&quot;, typeof(T));
            for (var i = 0; i &lt; array.GetLength(0); i++)
            {
                var row = table.NewRow();
                for (var j = 0; j &lt; array.GetLength(1); j++) row[j] = array[i, j];
                table.Rows.Add(row);
            }

            //ac&#225; se har&#225; el primer resize del DataGridView
            for (var i = 0; i &lt; controller.Tamanio; i++)
                dataGridView1.RowTemplate.Height = dataGridView1.Height / (int)numericUpDown1.Value;
            return table;
        }

        // Retorna el tipo de game segun el radio button seleccionado
        private Game GameSelector()
        {
            if (radioButton5.Checked)
                return new SimpleGame(controller.Board);
            return new GeneralGame(controller.Board);
        }

        private void ShowGameStatus()
        {
            switch (controller.Board.EstadoDeJuego)
            {
                case Tablero.GameState.JUGANDO:
                    EstadoJuego.Text = &quot;JUGANDO&quot;;
                    EstadoJuego.ForeColor = Color.Black;
                    break;
                case Tablero.GameState.GANOROJO:
                    EstadoJuego.Text = &quot;GAN&#211; EL JUGADOR ROJO&quot;;
                    EstadoJuego.ForeColor = Color.Red;
                    break;
                case Tablero.GameState.GANOAZUL:
                    EstadoJuego.Text = &quot;GAN&#211; EL JUGADOR AZUL&quot;;
                    EstadoJuego.ForeColor = Color.Blue;
                    break;
                case Tablero.GameState.EMPATE:
                    EstadoJuego.Text = &quot;EMPATE&quot;;
                    EstadoJuego.ForeColor = Color.Green;
                    break;
            }
        }

        //Este m&#233;todo cargar&#225; los datos de Grid al DataGridView        
        private void CargarAlDataGrid()
        {
            dataGridView1.DataSource = ConvertToDataTable(controller.Board.Grid);
            //Hace que al principio el color de la fuente 
            //sea blanca para que coincida con el color de fondo
            dataGridView1.DefaultCellStyle.ForeColor = Color.White;
            //Segundo resize del DataGridView
            for (var i = 0; i &lt; controller.Tamanio; i++)
                dataGridView1.RowTemplate.Height = dataGridView1.Height / ((int)numericUpDown1.Value + 1);
            //Que ninguna celda empiece seleccionada
            dataGridView1.CurrentCell = null;
        }

        //Este metodo asigna la ficha correspondiente al atributo Ficha del player al que se le pasa como parametro de acuerdo con los radio button
        private void AsignarFicha(Player player)
        {
            player.Ficha = controller.Turn == Tablero.Jugador.JAZUL
                ?
                FichaS_PlayerBlue.Checked ? Tablero.Cell.S : Tablero.Cell.O
                : FichaS_PlayerRed.Checked
                    ? Tablero.Cell.S
                    : Tablero.Cell.O;
        }

        //Este metodo pinta y coloca la ficha de la casilla en el DatagridView 
        private void PaintGrid()
        {
            if (controller.X &gt;= 0 &amp;&amp; controller.X &lt; controller.Board.Tamanio &amp;&amp;
                controller.Y &gt;= 0 &amp;&amp; controller.Y &lt; controller.Board.Tamanio)
            {
                // Desactiva la escucha para el update y no entre de neuvo a la funcion que captura el evento de updategrid
                dataGridView1.CellValueChanged -= UpdateGrid;
                controller.Board.Grid[controller.X, controller.Y] = controller.Ficha;
                dataGridView1.Rows[controller.X].Cells[controller.Y].Value = controller.Ficha;


                // Mientras se siga jugando (Estado de game == JUGANDO) Va pintar el valor del datagrid
                if (controller.Board.EstadoDeJuego == Tablero.GameState.JUGANDO)
                    dataGridView1.Rows[controller.X].Cells[controller.Y].Style.ForeColor =
                        controller.Turn == Tablero.Jugador.JROJO ? Color.Blue : Color.Red;
                else
                    dataGridView1.Rows[controller.X].Cells[controller.Y].Style.ForeColor =
                        controller.Turn == Tablero.Jugador.JROJO ? Color.Red : Color.Blue;
                //Es posible que la asignaci&#243;n de turnos est&#233; fallando aqu&#237;
                dataGridView1.CurrentCell = null; // Cuando se ahce click en el data grid ya no se sombreea azul
                dataGridView1.CellValueChanged += UpdateGrid; // Se vuelve a activar al escucha a este updategrid
            }
        }

        //Este metodo escucha cuando se clikea en la casilla de una Datagrid
        private void ClickeoGrid(object sender, DataGridViewCellEventArgs e)
        {
            // Se crean variables temporales para turno {JAZUL,JROJO} y player (Human o Computer)
            var turno = controller.Turn; // rellena el turno 
            var playerActual = controller.CurrentPlayer; // variable que alamcena el jugador actual
            if (playerActual is Human)
            {
                AsignarFicha(playerActual); // rellena el valor de ficha en palyerActual segun los radio button
                controller.CurrentPlayer.MakeMove(e.RowIndex, e.ColumnIndex, playerActual.Ficha, controller.Game);
                if (controller.Board.ValidMove &amp;&amp; controller.CurrentPlayer is Human) PaintGrid();
                ShowGameStatus();
                ShowTurn();
                controller.ChangeTurn();
            }

            if (controller.CurrentPlayer is Computer)
            {
                controller.CurrentPlayer.MakeMove(0, 0, 0,
                    controller.Game); // Realiza el movimiento del jugador de tipo Computer
                PaintGrid();
                ShowGameStatus();
                ShowTurn();
                controller.ChangeTurn();
            }
        }

        // Inicializa el tipo de jugador Azul segun los radiobutton
        private Player BluePlayerSelector()
        {
            if (radioButton10.Checked) return new Human(Tablero.Jugador.JAZUL);
            return new Computer(Tablero.Jugador.JAZUL);
        }

        // Inicializa el tipo de jugador Rojo segun los radiobutton
        private Player RedPlayerSelector()
        {
            if (radioButton8.Checked) return new Human(Tablero.Jugador.JROJO);
            return new Computer(Tablero.Jugador.JROJO);
        }

        // Restricci&#243;n: no se puede cambiar el tama&#241;o ni modo de game durante una partida
        private void ReIniciarJuego()
        {
            // Al ir cambiando  el &quot;numericUpDown1&quot; se va cambiando el tama&#241;o del tablero
            controller.Board = new Tablero((int)numericUpDown1.Value);
            if (controller.Game != null)
                GC.SuppressFinalize(controller.Game);
            controller.Game = GameSelector(); // Verifica los radio button y retorna el tipo de game seleccionado
            controller.Player1 =
                BluePlayerSelector(); // Verrifica el radio button y se asigna como jugador azul al primer player
            controller.Player2 =
                RedPlayerSelector(); // Verrifica el radio button y se asigna como jugador rojo al segundo player
            controller.InitTurn(); // Inicializa el CurrentPlayer como palyer1 , es decir el player1 empieza el game
            CargarAlDataGrid(); // Carga los datos al dataGrid
            ShowGameStatus(); // muestra en un label el estado del game
            ShowTurn(); // muetra en un label el turno
            dataGridView1.CurrentCell = null; // Se desaparece que este sombreado azul en el datagrid
            switch (controller.Player1)
            {
                case Computer _ when controller.Player2 is Human:
                    controller.CurrentPlayer.MakeMove(0, 0, 0,
                        controller.Game); // Realiza el movimiento del jugador de tipo Computer
                    PaintGrid();
                    ShowGameStatus();
                    ShowTurn();
                    controller.ChangeTurn();
                    break;
                case Computer _ when controller.Player2 is Computer:
                    StartComputerVsComputerGame();
                    break;
            }
        }

        private void StartComputerVsComputerGame()
        {
            // Desactiva los controles que no se deben modificar durante el game
            //numericUpDown1.Enabled = false;


            // Ciclo recursivo para que los jugadores computadoras realicen sus movimientos autom&#225;ticamente
            PerformComputerMove();
        }

        private void PerformComputerMove()
        {
            if (controller.CurrentPlayer is Computer)
            {
                Invoke((MethodInvoker)delegate
                {
                    controller.CurrentPlayer.MakeMove(0, 0, 0, controller.Game);
                    PaintGrid();
                    ShowGameStatus();
                    ShowTurn();
                    controller.ChangeTurn();
                });

                // Verifica si el game ha terminado
                if (controller.Board.EstadoDeJuego == 0)
                {
                    // Espera un breve per&#237;odo de tiempo antes de realizar el siguiente movimiento del jugador computadora
                    // Esto evita que los movimientos se realicen instant&#225;neamente y permite visualizarlos
                    var delayInMilliseconds = 1000; // Ajusta el tiempo de espera seg&#250;n tus necesidades
                    Task.Delay(delayInMilliseconds).ContinueWith(_ =&gt;
                    {
                        PerformComputerMove(); // Realiza el siguiente movimiento del jugador computadora
                    });
                }
                else
                {
                    EndComputerVsComputerGame(); // Finaliza el game entre las dos computadoras
                }
            }
        }

        private void EndComputerVsComputerGame()
        {
            // Realiza cualquier acci&#243;n necesaria al finalizar el game entre las dos computadoras

            // Reactiva los controles que se desactivaron durante el game
            //numericUpDown1.Enabled = true;
        }

        //Este metodo llama a la funcion reiniciarJuego
        private void NuevaPartida(object sender, EventArgs e)
        {
            ReIniciarJuego();
        }

        private void UpdateGrid(object sender, DataGridViewCellEventArgs e)
        {
        }

        //Este metodo muestra el turno en la interfaz grafica a traves del label : &quot;Turn&quot; y lo pinta segun el jugador actual
        private void ShowTurn()
        {
            Turno.Text = controller.Board.Turno.ToString();
            Turno.ForeColor = controller.Board.Turno == Tablero.Jugador.JAZUL ? Color.Blue : Color.Red;
        }

        private void label7_Click(object sender, EventArgs e)
        {
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,23,0],[17,9,17,10,0],[18,13,18,35,0],[19,13,19,43,0],[20,9,20,10,0],[24,9,24,10,0],[25,13,25,41,0],[26,18,26,27,0],[26,29,26,51,0],[26,53,26,56,0],[26,58,26,105,0],[27,18,27,27,0],[27,29,27,51,0],[27,53,27,56,0],[28,13,28,14,0],[29,17,29,42,0],[30,22,30,31,0],[30,33,30,55,0],[30,57,30,60,0],[30,62,30,83,0],[31,17,31,37,0],[32,13,32,14,0],[35,18,35,27,0],[35,29,35,51,0],[35,53,35,56,0],[36,17,36,101,0],[37,13,37,26,0],[38,9,38,10,0],[42,9,42,10,0],[43,13,43,38,0],[44,17,44,57,0],[45,13,45,54,0],[46,9,46,10,0],[49,9,49,10,0],[50,13,50,52,0],[53,21,53,50,0],[54,21,54,57,0],[55,21,55,27,0],[57,21,57,63,0],[58,21,58,55,0],[59,21,59,27,0],[61,21,61,63,0],[62,21,62,56,0],[63,21,63,27,0],[65,21,65,49,0],[66,21,66,57,0],[67,21,67,27,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,82,0],[77,13,77,68,0],[79,18,79,27,0],[79,29,79,51,0],[79,53,79,56,0],[80,17,80,107,0],[82,13,82,46,0],[83,9,83,10,0],[87,9,87,10,0],[88,13,93,38,0],[94,9,94,10,0],[98,9,98,10,0],[99,13,100,78,0],[101,13,101,14,0],[103,17,103,62,0],[104,17,104,86,0],[105,17,105,95,0],[109,17,109,81,0],[110,21,111,91,0],[113,21,114,91,0],[116,17,116,50,0],[117,17,117,62,0],[118,13,118,14,0],[119,9,119,10,0],[123,9,123,10,0],[125,13,125,41,0],[126,13,126,57,0],[127,13,127,39,0],[128,13,128,14,0],[129,17,129,44,0],[130,17,130,115,0],[131,17,131,85,0],[131,86,131,98,0],[132,17,132,34,0],[133,17,133,28,0],[134,17,134,41,0],[135,13,135,14,0],[137,13,137,54,0],[138,13,138,14,0],[139,17,140,38,0],[141,17,141,29,0],[142,17,142,34,0],[143,17,143,28,0],[144,17,144,41,0],[145,13,145,14,0],[146,9,146,10,0],[150,9,150,10,0],[151,13,151,39,0],[151,40,151,80,0],[152,13,152,56,0],[153,9,153,10,0],[157,9,157,10,0],[158,13,158,38,0],[158,39,158,79,0],[159,13,159,56,0],[160,9,160,10,0],[164,9,164,10,0],[166,13,166,71,0],[167,13,167,41,0],[168,17,168,54,0],[169,13,169,46,0],[170,13,171,38,0],[172,13,173,37,0],[174,13,174,35,0],[175,13,175,32,0],[176,13,176,30,0],[177,13,177,24,0],[178,13,178,46,0],[179,13,179,40,0],[181,33,181,65,0],[182,21,183,42,0],[184,21,184,33,0],[185,21,185,38,0],[186,21,186,32,0],[187,21,187,45,0],[188,21,188,27,0],[189,33,189,68,0],[190,21,190,51,0],[191,21,191,27,0],[193,9,193,10,0],[196,9,196,10,0],[202,13,202,35,0],[203,9,203,10,0],[206,9,206,10,0],[207,13,207,54,0],[208,13,208,14,0],[209,17,210,17,0],[210,17,210,18,0],[210,18,211,21,0],[211,21,211,81,0],[211,81,212,21,0],[212,21,212,33,0],[212,33,213,21,0],[213,21,213,38,0],[213,38,214,21,0],[214,21,214,32,0],[214,32,215,21,0],[215,21,215,45,0],[215,45,216,17,0],[216,17,216,18,0],[216,18,216,20,0],[219,17,219,57,0],[220,17,220,18,0],[223,21,223,52,0],[224,21,225,21,0],[225,21,225,22,0],[225,22,226,25,0],[226,25,226,47,0],[226,47,227,21,0],[227,21,227,22,0],[227,22,227,24,0],[228,17,228,18,0],[230,17,230,18,0],[231,21,231,49,0],[232,17,232,18,0],[233,13,233,14,0],[234,9,234,10,0],[237,9,237,10,0],[242,9,242,10,0],[246,9,246,10,0],[247,13,247,30,0],[248,9,248,10,0],[251,9,251,10,0],[252,9,252,10,0],[256,9,256,10,0],[257,13,257,60,0],[258,13,258,104,0],[259,9,259,10,0],[262,9,262,10,0],[263,9,263,10,0]]);
    </script>
  </body>
</html>